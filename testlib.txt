--[[
	UI Library - Conduit Style (Extended)
	Features: Windows, Sections, Buttons (with icons), Toggles, Sliders, Dropdowns, Labels,
	          ColorPickers, TabBars, Dividers.
	Author: Assistant
--]]

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local mouse = player:GetMouse()

local Library = {}
local windows = {}

-- Theme mặc định
local DefaultTheme = {
	MainColor = Color3.fromRGB(30, 30, 35),
	SecondaryColor = Color3.fromRGB(45, 45, 50),
	AccentColor = Color3.fromRGB(0, 120, 255),
	TextColor = Color3.fromRGB(255, 255, 255),
	ShadowColor = Color3.fromRGB(0, 0, 0),
	Font = Enum.Font.Gotham,
	Transparency = 0.05,
	CornerRadius = UDim.new(0, 8)
}

-- Hàm tạo hiệu ứng
local function tweenObject(obj, props, time, easingStyle)
	local tween = TweenService:Create(obj, TweenInfo.new(time, easingStyle), props)
	tween:Play()
	return tween
end

-- Hàm tạo UICorner
local function addCorner(obj, radius)
	local corner = Instance.new("UICorner")
	corner.CornerRadius = radius or UDim.new(0, 4)
	corner.Parent = obj
end

-- Lớp Window
local Window = {}
Window.__index = Window

function Window.new(title, size, theme)
	local self = setmetatable({}, Window)
	self.Theme = theme or DefaultTheme
	self.Title = title
	self.Size = size or UDim2.fromOffset(400, 500)
	self.Position = UDim2.fromOffset(200, 100)
	self.Elements = {}
	self.Sections = {}
	self.Minimized = false
	self.Dragging = false
	self.DragStart = nil
	self.DragOffset = nil

	self:CreateMainFrame()
	return self
end

function Window:CreateMainFrame()
	local screenGui = Instance.new("ScreenGui")
	screenGui.Name = "ConduitGUI"
	screenGui.ResetOnSpawn = false
	screenGui.Parent = player:WaitForChild("PlayerGui")

	-- Main window frame
	local frame = Instance.new("Frame")
	frame.Name = "MainWindow"
	frame.Size = self.Size
	frame.Position = self.Position
	frame.BackgroundColor3 = self.Theme.MainColor
	frame.BackgroundTransparency = self.Theme.Transparency
	frame.ClipsDescendants = true
	frame.Parent = screenGui

	-- Shadow
	local shadow = Instance.new("ImageLabel")
	shadow.Name = "Shadow"
	shadow.Size = UDim2.fromScale(1, 1) + UDim2.fromOffset(20, 20)
	shadow.Position = UDim2.fromOffset(-10, -10)
	shadow.BackgroundTransparency = 1
	shadow.Image = "rbxassetid://6014261993" -- 9 slice shadow
	shadow.ImageColor3 = self.Theme.ShadowColor
	shadow.ImageTransparency = 0.5
	shadow.ScaleType = Enum.ScaleType.Slice
	shadow.SliceCenter = Rect.new(10, 10, 10, 10)
	shadow.Parent = frame

	-- Top bar
	local topBar = Instance.new("Frame")
	topBar.Name = "TopBar"
	topBar.Size = UDim2.new(1, 0, 0, 30)
	topBar.BackgroundColor3 = self.Theme.SecondaryColor
	topBar.BackgroundTransparency = self.Theme.Transparency
	topBar.Parent = frame

	local titleLabel = Instance.new("TextLabel")
	titleLabel.Name = "Title"
	titleLabel.Size = UDim2.new(1, -40, 1, 0)
	titleLabel.Position = UDim2.fromOffset(10, 0)
	titleLabel.BackgroundTransparency = 1
	titleLabel.Text = self.Title
	titleLabel.TextColor3 = self.Theme.TextColor
	titleLabel.Font = self.Theme.Font
	titleLabel.TextSize = 18
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	titleLabel.Parent = topBar

	-- Minimize button
	local minButton = Instance.new("TextButton")
	minButton.Name = "Minimize"
	minButton.Size = UDim2.fromOffset(25, 25)
	minButton.Position = UDim2.new(1, -60, 0, 2.5)
	minButton.BackgroundColor3 = self.Theme.AccentColor
	minButton.Text = "−"
	minButton.TextColor3 = self.Theme.TextColor
	minButton.Font = self.Theme.Font
	minButton.TextSize = 20
	minButton.Parent = topBar

	-- Close button
	local closeButton = Instance.new("TextButton")
	closeButton.Name = "Close"
	closeButton.Size = UDim2.fromOffset(25, 25)
	closeButton.Position = UDim2.new(1, -30, 0, 2.5)
	closeButton.BackgroundColor3 = Color3.fromRGB(255, 70, 70)
	closeButton.Text = "×"
	closeButton.TextColor3 = self.Theme.TextColor
	closeButton.Font = self.Theme.Font
	closeButton.TextSize = 20
	closeButton.Parent = topBar

	-- Container (ScrollingFrame)
	local container = Instance.new("ScrollingFrame")
	container.Name = "Container"
	container.Size = UDim2.new(1, -20, 1, -40)
	container.Position = UDim2.fromOffset(10, 40)
	container.BackgroundTransparency = 1
	container.BorderSizePixel = 0
	container.ScrollBarThickness = 6
	container.ScrollBarImageColor3 = self.Theme.AccentColor
	container.AutomaticCanvasSize = Enum.AutomaticSize.Y
	container.CanvasSize = UDim2.fromScale(0, 0)
	container.Parent = frame

	-- Rounded corners
	local corner = Instance.new("UICorner")
	corner.CornerRadius = self.Theme.CornerRadius
	corner.Parent = frame

	local topBarCorner = Instance.new("UICorner")
	topBarCorner.CornerRadius = self.Theme.CornerRadius
	topBarCorner.Parent = topBar

	-- Stroke
	local stroke = Instance.new("UIStroke")
	stroke.Color = self.Theme.SecondaryColor
	stroke.Thickness = 1
	stroke.Parent = frame

	-- Gradient cho top bar
	local gradient = Instance.new("UIGradient")
	gradient.Color = ColorSequence.new({
		ColorSequenceKeypoint.new(0, self.Theme.SecondaryColor),
		ColorSequenceKeypoint.new(1, self.Theme.SecondaryColor:Lerp(Color3.new(0,0,0), 0.2))
	})
	gradient.Parent = topBar

	self.Frame = frame
	self.Container = container
	self.TopBar = topBar
	self.MinimizeButton = minButton
	self.CloseButton = closeButton
	self.ScreenGui = screenGui

	-- Dragging
	topBar.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			self.Dragging = true
			self.DragOffset = input.Position - frame.AbsolutePosition
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if self.Dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
			local newPos = UDim2.fromOffset(input.Position.X - self.DragOffset.X, input.Position.Y - self.DragOffset.Y)
			frame.Position = newPos
		end
	end)

	UserInputService.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			self.Dragging = false
		end
	end)

	-- Minimize
	minButton.MouseButton1Click:Connect(function()
		self.Minimized = not self.Minimized
		local targetSize = self.Minimized and UDim2.fromOffset(self.Size.X.Offset, 40) or self.Size
		tweenObject(frame, {Size = targetSize}, 0.2, Enum.EasingStyle.Quad)
		container.Visible = not self.Minimized
	end)

	-- Close
	closeButton.MouseButton1Click:Connect(function()
		tweenObject(frame, {BackgroundTransparency = 1, Size = UDim2.fromOffset(0,0)}, 0.2, Enum.EasingStyle.Quad)
		wait(0.2)
		screenGui:Destroy()
	end)
end

-- Thêm section
function Window:AddSection(name)
	local section = {}
	section.Name = name
	section.Elements = {}

	local sectionFrame = Instance.new("Frame")
	sectionFrame.Name = name.."Section"
	sectionFrame.Size = UDim2.new(1, 0, 0, 30)
	sectionFrame.BackgroundTransparency = 1
	sectionFrame.Parent = self.Container

	local titleLabel = Instance.new("TextLabel")
	titleLabel.Size = UDim2.new(1, -10, 1, 0)
	titleLabel.Position = UDim2.fromOffset(5, 0)
	titleLabel.BackgroundTransparency = 1
	titleLabel.Text = name
	titleLabel.TextColor3 = self.Theme.AccentColor
	titleLabel.Font = self.Theme.Font
	titleLabel.TextSize = 16
	titleLabel.TextXAlignment = Enum.TextXAlignment.Left
	titleLabel.Parent = sectionFrame

	local line = Instance.new("Frame")
	line.Size = UDim2.new(1, -10, 0, 1)
	line.Position = UDim2.new(0, 5, 1, -2)
	line.BackgroundColor3 = self.Theme.AccentColor
	line.BackgroundTransparency = 0.5
	line.Parent = sectionFrame

	section.Frame = sectionFrame
	table.insert(self.Sections, section)
	return section
end

-- Thêm nút (có thể có icon)
function Window:AddButton(section, text, callback, iconAssetId)
	local buttonFrame = Instance.new("Frame")
	buttonFrame.Name = text.."ButtonFrame"
	buttonFrame.Size = UDim2.new(1, 0, 0, 35)
	buttonFrame.BackgroundTransparency = 1
	buttonFrame.Parent = self.Container

	local button = Instance.new("TextButton")
	button.Name = text
	button.Size = UDim2.new(1, -10, 0, 30)
	button.Position = UDim2.fromOffset(5, 2.5)
	button.BackgroundColor3 = self.Theme.SecondaryColor
	button.BackgroundTransparency = self.Theme.Transparency
	button.Text = ""
	button.Parent = buttonFrame

	addCorner(button, UDim.new(0, 4))

	-- Icon (nếu có)
	local icon
	if iconAssetId then
		icon = Instance.new("ImageLabel")
		icon.Size = UDim2.fromOffset(20, 20)
		icon.Position = UDim2.fromOffset(8, 5)
		icon.BackgroundTransparency = 1
		icon.Image = iconAssetId
		icon.ImageColor3 = self.Theme.TextColor
		icon.Parent = button
	end

	-- Label
	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, icon and -36 or -10, 1, 0)
	label.Position = UDim2.fromOffset(icon and 36 or 5, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = self.Theme.TextColor
	label.Font = self.Theme.Font
	label.TextSize = 14
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = button

	-- Hover effect
	button.MouseEnter:Connect(function()
		tweenObject(button, {BackgroundTransparency = self.Theme.Transparency - 0.1}, 0.1)
	end)
	button.MouseLeave:Connect(function()
		tweenObject(button, {BackgroundTransparency = self.Theme.Transparency}, 0.1)
	end)

	button.MouseButton1Click:Connect(function()
		callback()
	end)

	-- Adjust container canvas size
	RunService.Heartbeat:Wait()
	self.Container.CanvasSize = UDim2.new(0, 0, 0, self.Container.AbsoluteCanvasSize.Y)
end

-- Thêm nút với icon (giữ tương thích, nhưng có thể dùng AddButton với tham số icon)
Window.AddButtonWithIcon = Window.AddButton -- vì AddButton đã hỗ trợ icon

-- Thêm toggle
function Window:AddToggle(section, text, default, callback)
	local toggleFrame = Instance.new("Frame")
	toggleFrame.Name = text.."ToggleFrame"
	toggleFrame.Size = UDim2.new(1, 0, 0, 35)
	toggleFrame.BackgroundTransparency = 1
	toggleFrame.Parent = self.Container

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(0.8, -10, 1, 0)
	label.Position = UDim2.fromOffset(5, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = self.Theme.TextColor
	label.Font = self.Theme.Font
	label.TextSize = 14
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = toggleFrame

	local toggleBtn = Instance.new("TextButton")
	toggleBtn.Name = "Toggle"
	toggleBtn.Size = UDim2.fromOffset(40, 20)
	toggleBtn.Position = UDim2.new(1, -45, 0, 7.5)
	toggleBtn.BackgroundColor3 = default and self.Theme.AccentColor or Color3.fromRGB(80,80,80)
	toggleBtn.Text = ""
	toggleBtn.Parent = toggleFrame

	local circle = Instance.new("Frame")
	circle.Name = "Circle"
	circle.Size = UDim2.fromOffset(16, 16)
	circle.Position = default and UDim2.fromOffset(22, 2) or UDim2.fromOffset(2, 2)
	circle.BackgroundColor3 = Color3.new(1,1,1)
	circle.Parent = toggleBtn

	addCorner(toggleBtn, UDim.new(1, 0))
	addCorner(circle, UDim.new(1, 0))

	local state = default or false

	local function updateToggle()
		local pos = state and UDim2.fromOffset(22, 2) or UDim2.fromOffset(2, 2)
		local color = state and self.Theme.AccentColor or Color3.fromRGB(80,80,80)
		tweenObject(circle, {Position = pos}, 0.15)
		tweenObject(toggleBtn, {BackgroundColor3 = color}, 0.15)
		callback(state)
	end

	toggleBtn.MouseButton1Click:Connect(function()
		state = not state
		updateToggle()
	end)

	updateToggle()
end

-- Thêm slider
function Window:AddSlider(section, text, min, max, default, callback)
	local sliderFrame = Instance.new("Frame")
	sliderFrame.Name = text.."SliderFrame"
	sliderFrame.Size = UDim2.new(1, 0, 0, 45)
	sliderFrame.BackgroundTransparency = 1
	sliderFrame.Parent = self.Container

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(0.7, -10, 0, 20)
	label.Position = UDim2.fromOffset(5, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = self.Theme.TextColor
	label.Font = self.Theme.Font
	label.TextSize = 14
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = sliderFrame

	local valueLabel = Instance.new("TextLabel")
	valueLabel.Size = UDim2.new(0.3, -10, 0, 20)
	valueLabel.Position = UDim2.new(0.7, 0, 0, 0)
	valueLabel.BackgroundTransparency = 1
	valueLabel.Text = tostring(default)
	valueLabel.TextColor3 = self.Theme.AccentColor
	valueLabel.Font = self.Theme.Font
	valueLabel.TextSize = 14
	valueLabel.TextXAlignment = Enum.TextXAlignment.Right
	valueLabel.Parent = sliderFrame

	local sliderBar = Instance.new("Frame")
	sliderBar.Name = "Bar"
	sliderBar.Size = UDim2.new(1, -10, 0, 4)
	sliderBar.Position = UDim2.new(0, 5, 1, -12)
	sliderBar.BackgroundColor3 = self.Theme.SecondaryColor
	sliderBar.Parent = sliderFrame

	local fill = Instance.new("Frame")
	fill.Name = "Fill"
	fill.Size = UDim2.new((default - min)/(max - min), 0, 1, 0)
	fill.BackgroundColor3 = self.Theme.AccentColor
	fill.Parent = sliderBar

	local knob = Instance.new("Frame")
	knob.Name = "Knob"
	knob.Size = UDim2.fromOffset(12, 12)
	knob.Position = UDim2.new((default - min)/(max - min), -6, 0, -4)
	knob.BackgroundColor3 = self.Theme.TextColor
	knob.Parent = sliderBar

	addCorner(sliderBar, UDim.new(1, 0))
	addCorner(fill, UDim.new(1, 0))
	addCorner(knob, UDim.new(1, 0))

	local dragging = false
	local function updateSlider(input)
		local x = math.clamp(input.Position.X - sliderBar.AbsolutePosition.X, 0, sliderBar.AbsoluteSize.X)
		local percent = x / sliderBar.AbsoluteSize.X
		local value = min + percent * (max - min)
		value = math.floor(value * 100) / 100
		fill.Size = UDim2.new(percent, 0, 1, 0)
		knob.Position = UDim2.new(percent, -6, 0, -4)
		valueLabel.Text = tostring(value)
		callback(value)
	end

	knob.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
			updateSlider(input)
		end
	end)

	UserInputService.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)

	sliderBar.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			updateSlider(input)
			dragging = true
		end
	end)
end

-- Thêm dropdown
function Window:AddDropdown(section, text, options, default, callback)
	local dropdownFrame = Instance.new("Frame")
	dropdownFrame.Name = text.."DropdownFrame"
	dropdownFrame.Size = UDim2.new(1, 0, 0, 35)
	dropdownFrame.BackgroundTransparency = 1
	dropdownFrame.Parent = self.Container

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(0.5, -10, 1, 0)
	label.Position = UDim2.fromOffset(5, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = self.Theme.TextColor
	label.Font = self.Theme.Font
	label.TextSize = 14
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = dropdownFrame

	local dropdownBtn = Instance.new("TextButton")
	dropdownBtn.Name = "DropdownButton"
	dropdownBtn.Size = UDim2.new(0.5, -10, 0, 25)
	dropdownBtn.Position = UDim2.new(0.5, 0, 0, 5)
	dropdownBtn.BackgroundColor3 = self.Theme.SecondaryColor
	dropdownBtn.BackgroundTransparency = self.Theme.Transparency
	dropdownBtn.Text = default or options[1] or "..."
	dropdownBtn.TextColor3 = self.Theme.TextColor
	dropdownBtn.Font = self.Theme.Font
	dropdownBtn.TextSize = 14
	dropdownBtn.Parent = dropdownFrame

	addCorner(dropdownBtn, UDim.new(0, 4))

	local listFrame = Instance.new("Frame")
	listFrame.Name = "List"
	listFrame.Size = UDim2.new(0.5, -10, 0, 0)
	listFrame.Position = UDim2.new(0.5, 0, 0, 30)
	listFrame.BackgroundColor3 = self.Theme.SecondaryColor
	listFrame.BackgroundTransparency = self.Theme.Transparency
	listFrame.Visible = false
	listFrame.Parent = dropdownFrame
	addCorner(listFrame, UDim.new(0, 4))

	local listLayout = Instance.new("UIListLayout")
	listLayout.Parent = listFrame

	local function showList()
		listFrame.Visible = true
		listFrame.Size = UDim2.new(0.5, -10, 0, #options * 25)
	end

	local function hideList()
		listFrame.Visible = false
	end

	for _, opt in ipairs(options) do
		local optBtn = Instance.new("TextButton")
		optBtn.Size = UDim2.new(1, 0, 0, 25)
		optBtn.BackgroundTransparency = 1
		optBtn.Text = opt
		optBtn.TextColor3 = self.Theme.TextColor
		optBtn.Font = self.Theme.Font
		optBtn.TextSize = 14
		optBtn.Parent = listFrame

		optBtn.MouseEnter:Connect(function()
			optBtn.BackgroundTransparency = 0.8
		end)
		optBtn.MouseLeave:Connect(function()
			optBtn.BackgroundTransparency = 1
		end)

		optBtn.MouseButton1Click:Connect(function()
			dropdownBtn.Text = opt
			hideList()
			callback(opt)
		end)
	end

	dropdownBtn.MouseButton1Click:Connect(function()
		if listFrame.Visible then
			hideList()
		else
			showList()
		end
	end)

	UserInputService.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			local target = input.Target
			if target and target:IsDescendantOf(dropdownFrame) == false then
				hideList()
			end
		end
	end)
end

-- Thêm label
function Window:AddLabel(section, text)
	local labelFrame = Instance.new("Frame")
	labelFrame.Name = "LabelFrame"
	labelFrame.Size = UDim2.new(1, 0, 0, 25)
	labelFrame.BackgroundTransparency = 1
	labelFrame.Parent = self.Container

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, -10, 1, 0)
	label.Position = UDim2.fromOffset(5, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = self.Theme.TextColor
	label.Font = self.Theme.Font
	label.TextSize = 14
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = labelFrame
end

-- Thêm Divider
function Window:AddDivider(section)
	local dividerFrame = Instance.new("Frame")
	dividerFrame.Name = "Divider"
	dividerFrame.Size = UDim2.new(1, -20, 0, 1)
	dividerFrame.Position = UDim2.fromOffset(10, 0)
	dividerFrame.BackgroundColor3 = self.Theme.AccentColor
	dividerFrame.BackgroundTransparency = 0.7
	dividerFrame.Parent = self.Container

	-- Tạo khoảng cách phía trên và dưới bằng một frame trong suốt
	local spacer = Instance.new("Frame")
	spacer.Size = UDim2.new(1, 0, 0, 10)
	spacer.BackgroundTransparency = 1
	spacer.Parent = self.Container

	-- Đưa dividerFrame lên trên spacer
	dividerFrame.Parent = spacer -- gán vào spacer để tự động canh giữa? không, tốt nhất đặt sau spacer.
	-- Sắp xếp: để divider nằm giữa hai khoảng trống, ta sẽ tạo một frame chứa divider với padding.
	-- Cách đơn giản: thêm một frame trong suốt cao 10, bên trong có divider ở giữa.
	local container = Instance.new("Frame")
	container.Size = UDim2.new(1, 0, 0, 11)
	container.BackgroundTransparency = 1
	container.Parent = self.Container

	dividerFrame.Parent = container
	dividerFrame.Position = UDim2.fromOffset(10, 5) -- canh giữa theo chiều dọc

	-- Cập nhật canvas
	RunService.Heartbeat:Wait()
	self.Container.CanvasSize = UDim2.new(0, 0, 0, self.Container.AbsoluteCanvasSize.Y)
end

-- Thêm ColorPicker
function Window:AddColorPicker(section, text, defaultColor, callback)
	local colorFrame = Instance.new("Frame")
	colorFrame.Name = text.."ColorFrame"
	colorFrame.Size = UDim2.new(1, 0, 0, 35)
	colorFrame.BackgroundTransparency = 1
	colorFrame.Parent = self.Container

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(0.7, -10, 1, 0)
	label.Position = UDim2.fromOffset(5, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = self.Theme.TextColor
	label.Font = self.Theme.Font
	label.TextSize = 14
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Parent = colorFrame

	local colorBtn = Instance.new("TextButton")
	colorBtn.Name = "ColorButton"
	colorBtn.Size = UDim2.new(0, 30, 0, 20)
	colorBtn.Position = UDim2.new(1, -35, 0, 7.5)
	colorBtn.BackgroundColor3 = defaultColor or Color3.new(1,1,1)
	colorBtn.Text = ""
	colorBtn.Parent = colorFrame
	addCorner(colorBtn, UDim.new(0, 4))

	-- Popup chọn màu (dạng lưới đơn giản)
	local popup = Instance.new("Frame")
	popup.Name = "ColorPopup"
	popup.Size = UDim2.fromOffset(150, 120)
	popup.Position = UDim2.fromOffset(0, 25)
	popup.BackgroundColor3 = self.Theme.SecondaryColor
	popup.BackgroundTransparency = self.Theme.Transparency
	popup.Visible = false
	popup.Parent = colorBtn
	addCorner(popup, UDim.new(0, 4))

	local grid = Instance.new("UIGridLayout")
	grid.CellSize = UDim2.fromOffset(20, 20)
	grid.CellPadding = UDim2.fromOffset(4, 4)
	grid.FillDirection = Enum.FillDirection.Horizontal
	grid.StartCorner = Enum.StartCorner.TopLeft
	grid.Parent = popup

	-- Tạo các ô màu cơ bản
	local colors = {
		Color3.new(1,0,0), Color3.new(0,1,0), Color3.new(0,0,1),
		Color3.new(1,1,0), Color3.new(1,0,1), Color3.new(0,1,1),
		Color3.new(1,1,1), Color3.new(0,0,0), Color3.new(0.5,0.5,0.5),
		Color3.new(1,0.5,0), Color3.new(0.5,0,1), Color3.new(0,0.8,0.5)
	}

	for _, col in ipairs(colors) do
		local swatch = Instance.new("TextButton")
		swatch.Size = UDim2.fromOffset(20, 20)
		swatch.BackgroundColor3 = col
		swatch.Text = ""
		swatch.Parent = popup
		addCorner(swatch, UDim.new(0, 2))

		swatch.MouseButton1Click:Connect(function()
			colorBtn.BackgroundColor3 = col
			popup.Visible = false
			callback(col)
		end)
	end

	colorBtn.MouseButton1Click:Connect(function()
		popup.Visible = not popup.Visible
	end)

	-- Ẩn popup khi click ra ngoài
	UserInputService.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			local target = input.Target
			if target and target:IsDescendantOf(colorBtn) == false then
				popup.Visible = false
			end
		end
	end)

	RunService.Heartbeat:Wait()
	self.Container.CanvasSize = UDim2.new(0, 0, 0, self.Container.AbsoluteCanvasSize.Y)
end

-- Thêm Tab Bar (thanh tab ngang)
function Window:AddTabBar(section, tabs)
	-- tabs là mảng các bản ghi: { name = "Tab1", icon = assetId, callback = function(activeTab) }
	local barFrame = Instance.new("Frame")
	barFrame.Name = "TabBar"
	barFrame.Size = UDim2.new(1, -10, 0, 40)
	barFrame.Position = UDim2.fromOffset(5, 0)
	barFrame.BackgroundTransparency = 1
	barFrame.Parent = self.Container

	local layout = Instance.new("UIListLayout")
	layout.FillDirection = Enum.FillDirection.Horizontal
	layout.HorizontalAlignment = Enum.HorizontalAlignment.Left
	layout.VerticalAlignment = Enum.VerticalAlignment.Center
	layout.Padding = UDim.new(0, 5)
	layout.Parent = barFrame

	local activeTab = nil

	local function setActive(tabBtn)
		if activeTab then
			tweenObject(activeTab, {BackgroundTransparency = self.Theme.Transparency}, 0.1)
		end
		tweenObject(tabBtn, {BackgroundTransparency = self.Theme.Transparency - 0.2}, 0.1)
		activeTab = tabBtn
	end

	for i, tabData in ipairs(tabs) do
		local tabBtn = Instance.new("TextButton")
		tabBtn.Name = tabData.name.."Tab"
		tabBtn.Size = UDim2.fromOffset(100, 30)
		tabBtn.BackgroundColor3 = self.Theme.SecondaryColor
		tabBtn.BackgroundTransparency = self.Theme.Transparency
		tabBtn.Text = ""
		tabBtn.Parent = barFrame
		addCorner(tabBtn, UDim.new(0, 4))

		-- Icon (nếu có)
		local icon
		if tabData.icon then
			icon = Instance.new("ImageLabel")
			icon.Size = UDim2.fromOffset(16, 16)
			icon.Position = UDim2.fromOffset(6, 7)
			icon.BackgroundTransparency = 1
			icon.Image = tabData.icon
			icon.ImageColor3 = self.Theme.TextColor
			icon.Parent = tabBtn
		end

		-- Label
		local label = Instance.new("TextLabel")
		label.Size = UDim2.new(1, icon and -28 or -10, 1, 0)
		label.Position = UDim2.fromOffset(icon and 28 or 5, 0)
		label.BackgroundTransparency = 1
		label.Text = tabData.name
		label.TextColor3 = self.Theme.TextColor
		label.Font = self.Theme.Font
		label.TextSize = 14
		label.TextXAlignment = Enum.TextXAlignment.Left
		label.Parent = tabBtn

		tabBtn.MouseButton1Click:Connect(function()
			setActive(tabBtn)
			if tabData.callback then
				tabData.callback(tabData.name)
			end
		end)

		-- Active tab đầu tiên
		if i == 1 then
			setActive(tabBtn)
		end
	end

	-- Điều chỉnh kích thước barFrame theo số lượng tab
	RunService.Heartbeat:Wait()
	barFrame.Size = UDim2.new(1, -10, 0, layout.AbsoluteContentSize.Y)
	self.Container.CanvasSize = UDim2.new(0, 0, 0, self.Container.AbsoluteCanvasSize.Y)
end

-- Hàm tạo cửa sổ (public)
function Library:CreateWindow(title, size, theme)
	local win = Window.new(title, size, theme)
	table.insert(windows, win)
	return win
end

return Library
